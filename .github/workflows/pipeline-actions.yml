name: Wisecow CI/CD workflow

on:
    push:
        branches:
            - main

env:
    KUBECONFIG: ${{ secrets.KUBECONFIG }}
    AWS_REGION: us-east-1
    ECR_REGISTRY: 661239473781.dkr.ecr.us-east-1.amazonaws.com


jobs:
    build:
        name: Build & push docker image
        runs-on: ubuntu-latest
        env:
            IMG_NAME: wisecow

        steps:

        - name: Checkout code
          uses: actions/checkout@v4

        - name: Debug
          run: |
            echo "github.ref -> {{ github.ref }}"
        
        - name: Docker metadata
          id: metadata
          uses: docker/metadata-action@v3
          with:
              images: ${{ env.IMG_NAME }}
              tags: latest
        
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v1
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Login to Amazon ECR
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          run: |
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}
        - name: Build and push Docker image
          env:
            REGISTRY: ${{ env.ECR_REGISTRY }}
          run: |
           docker build -t $REGISTRY/${{ env.IMG_NAME }}:latest .
           docker push $REGISTRY/${{ env.IMG_NAME }}:latest

    deploy:
      needs: build
      runs-on: ubuntu-latest

      steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to k8s
        uses: kodermax/kubectl-aws-eks@main
        # env:
        #   KUBECONFIG: ${{ env.KUBECONFIG }}
        #   ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
        #   ECR_REPOSITORY: wisecow
        #   IMAGE_TAG: latest
        with:
          args: apply -f kubernetes/deployment.yml -f kubernetes/service.yml
        